import{F as r,E as t}from"./vendor-AZjfysqh.js";import{f as u}from"./date-DAJMpUuB.js";import{u as G}from"./index-CcBKZM2H.js";import"./router-CieCW4vl.js";function te(){const{listAllLeaves:z,reviewLeave:A,deleteLeave:M,getMyTeamUsers:T,users:h,currentUser:l}=G(),[J,_]=r.useState([]),[K,y]=r.useState([]),[f,b]=r.useState([]),[v,w]=r.useState(""),[j,S]=r.useState(()=>new Date().toISOString().slice(0,7)),[x,L]=r.useState(!1),[V,D]=r.useState(!0),B=(e="")=>String(e||"").trim().replace(/\s+/g," ").toLowerCase(),R=(e=>{const a=B(e);return a.replace(/\s+/g,"").includes("hrbplead")||a.includes("hrbp")&&a.includes("lead")})((l==null?void 0:l.designation)||(l==null?void 0:l.position)||""),C=(e="")=>String(e||"").trim().toLowerCase(),F=(e={})=>`${String((e==null?void 0:e.firstName)||"").trim()} ${String((e==null?void 0:e.lastName)||"").trim()}`.trim().toLowerCase(),E=(e=[])=>{const a=C(l==null?void 0:l.email),i=F(l);if(!a&&!i)return[];const n=s=>{const o=String(s??"").trim();if(!o)return!1;const p=o.toLowerCase();return a&&p===a||i&&p===i};return(e||[]).filter(s=>String((s==null?void 0:s.role)||"").toLowerCase()==="employee").filter(s=>{const o=C(s==null?void 0:s.teamLeadEmail);return a&&o&&o===a?!0:[s==null?void 0:s.reportingTo,s==null?void 0:s.reporting_to,s==null?void 0:s.reportingToEmail,s==null?void 0:s.reporting_to_email,s==null?void 0:s.managerEmail,s==null?void 0:s.manager,s==null?void 0:s["Reporting To"],s==null?void 0:s.ReportingTo,s==null?void 0:s.ReportingToEmail].some(n)})},W=(e=[])=>e.map(a=>({id:a.id,employeeEmail:a.email,employeeName:a.email,leaveType:a.type||"Leave",startDate:a.from,endDate:a.to,days:a.duration!=null?Number(a.duration):Math.max(1,Math.ceil((new Date(a.to)-new Date(a.from))/(1e3*60*60*24))+1),partOfDay:a.partOfDay||a.part_of_day||void 0,reason:a.reason||"",status:String(a.status||"").toLowerCase(),approvedBy:a.approverEmail||"",approvedAt:a.updatedAt||a.createdAt,createdAt:a.createdAt})),k=async()=>{try{if(R){const a=E(Array.isArray(h)?h:[]);return y(a||[]),a||[]}const e=await T();return y(e||[]),e||[]}catch(e){if(console.error("Failed to load team members:",e),R){const a=E(Array.isArray(h)?h:[]);return y(a||[]),a||[]}return[]}},c=async()=>{try{D(!0);const a=(await k()).map(s=>{var o;return(o=s.email)==null?void 0:o.toLowerCase()}),i=await z(),n=W(i),g=n.filter(s=>{var o;return a.includes((o=s.employeeEmail)==null?void 0:o.toLowerCase())});_(n),b(g)}catch(e){console.warn("Failed to load leaves",e),b([])}finally{D(!1)}};r.useEffect(()=>{c()},[]),r.useEffect(()=>{const e=setInterval(()=>{c()},5e3);return()=>clearInterval(e)},[]),r.useEffect(()=>{const e=()=>c();try{window.addEventListener("erp-leaves-updated",e)}catch{}return()=>{try{window.removeEventListener("erp-leaves-updated",e)}catch{}}},[]);const N=async(e,a)=>{const i=a==="approved"?"Approved":a==="rejected"?"Rejected":"Pending";try{await A(e,i),await c()}catch(n){alert((n==null?void 0:n.message)||"Failed to update status")}},I=async e=>{if(confirm("Delete this leave request?"))try{await M(e),await c()}catch(a){alert((a==null?void 0:a.message)||"Failed to delete leave")}},H=e=>{switch(e){case"pending":return"#ffa500";case"approved":return"#28a745";case"rejected":return"#dc3545";case"manager_pending":return"#17a2b8";default:return"#6c757d"}},O=e=>{const a=new Date,i=a.getMonth(),n=a.getFullYear(),g=d=>d.getMonth()===i&&d.getFullYear()===n,o=(f||[]).filter(d=>(d.employeeEmail||"").toLowerCase()===(e||"").toLowerCase()&&String(d.status||"").toLowerCase()==="approved"&&g(new Date(String(d.startDate).slice(0,10)))).reduce((d,Q)=>d+(Number(Q.days)||0),0),p=1.5;return{remaining:Math.max(0,p-o),used:o,allowance:p}},m=r.useMemo(()=>{if(x)return[];const e=v.toLowerCase(),a=n=>{try{return String(new Date(n).toISOString()).slice(0,7)===j}catch{return!0}},i=f.filter(n=>n.status==="pending"||n.status==="manager_pending"||n.status==="admin_pending"||n.status==="approved"||n.status==="rejected").filter(n=>a(n.startDate));return e?i.filter(n=>[n.employeeName,n.employeeEmail,n.leaveType,n.reason,n.status].join(" ").toLowerCase().includes(e)):i},[f,v,j,x]),P=m.filter(e=>e.status==="pending"||e.status==="manager_pending"||e.status==="admin_pending").length,Y=m.filter(e=>e.status==="approved").length,$=m.filter(e=>e.status==="rejected").length;return t.jsxs("div",{className:"dashboard fade-in",children:[t.jsx("h2",{children:"ðŸ–ï¸ Leave Requests Management"}),t.jsxs("div",{className:"dashboard-grid",style:{marginBottom:"16px",gap:"12px",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))"},children:[t.jsxs("div",{className:"dashboard-card",style:{background:"#fff3cd",padding:"14px",borderRadius:"10px"},children:[t.jsx("h3",{style:{color:"#856404",fontSize:"16px",marginBottom:"6px"},children:"â³ Pending"}),t.jsx("p",{style:{fontSize:"18px",fontWeight:"bold",color:"#856404",margin:0},children:P})]}),t.jsxs("div",{className:"dashboard-card",style:{background:"#d4edda",padding:"14px",borderRadius:"10px"},children:[t.jsx("h3",{style:{color:"#155724",fontSize:"16px",marginBottom:"6px"},children:"âœ… Approved"}),t.jsx("p",{style:{fontSize:"18px",fontWeight:"bold",color:"#155724",margin:0},children:Y})]}),t.jsxs("div",{className:"dashboard-card",style:{background:"#f8d7da",padding:"14px",borderRadius:"10px"},children:[t.jsx("h3",{style:{color:"#721c24",fontSize:"16px",marginBottom:"6px"},children:"âŒ Rejected"}),t.jsx("p",{style:{fontSize:"18px",fontWeight:"bold",color:"#721c24",margin:0},children:$})]})]}),t.jsxs("div",{style:{display:"flex",gap:12,marginBottom:12,flexWrap:"wrap"},children:[t.jsx("input",{placeholder:"Search by employee name, email, leave type...",value:v,onChange:e=>w(e.target.value),style:{maxWidth:360}}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("label",{style:{fontSize:12,color:"#555"},children:"Month:"}),t.jsx("input",{type:"month",value:j,onChange:e=>S(e.target.value)})]}),t.jsx("button",{type:"button",className:"btn-outline",onClick:()=>{if(x){L(!1),c();try{console.debug("Admin LeaveRequests: table restored")}catch{}}else{w(""),S(new Date().toISOString().slice(0,7)),L(!0);try{console.debug("Admin LeaveRequests: table cleared (UI only)")}catch{}}},children:x?"Show Data":"Clear Table"})]}),t.jsx("div",{className:"table-wrapper",children:t.jsxs("table",{className:"leave-requests-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{style:{width:"90px"},children:"Submitted"}),t.jsx("th",{style:{width:"180px"},children:"Employee & Leaves"}),t.jsx("th",{style:{width:"100px"},children:"Leave Type"}),t.jsx("th",{style:{width:"90px"},children:"Start Date"}),t.jsx("th",{style:{width:"90px"},children:"End Date"}),t.jsx("th",{style:{width:"60px"},children:"Days"}),t.jsx("th",{style:{width:"200px"},children:"Reason"}),t.jsx("th",{style:{width:"100px"},children:"Status"}),t.jsx("th",{style:{width:"100px"},children:"Team Lead"}),t.jsx("th",{style:{width:"120px"},children:"Actions"})]})}),t.jsx("tbody",{children:m.length===0?t.jsx("tr",{children:t.jsx("td",{colSpan:"10",style:{textAlign:"center"},children:"No leave requests found."})}):m.map(e=>t.jsxs("tr",{children:[t.jsx("td",{style:{fontSize:"12px"},children:u(e.createdAt)}),t.jsx("td",{children:t.jsxs("div",{style:{lineHeight:"1.3"},children:[t.jsx("strong",{style:{fontSize:"13px"},children:e.employeeName}),t.jsx("br",{}),(()=>{const a=O(e.employeeEmail),i=a.remaining===0?"#dc3545":a.remaining===1?"#ffa500":"#28a745";return t.jsxs("small",{style:{color:i,fontSize:"11px",fontWeight:"600",display:"flex",alignItems:"center",gap:"4px"},children:[t.jsx("span",{children:"ðŸ“…"}),a.remaining," leaves left this month",t.jsxs("span",{style:{color:"#666",fontWeight:"400"},children:["(",a.used,"/",a.allowance," used)"]})]})})()]})}),t.jsx("td",{children:t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:2},children:[t.jsx("span",{className:"leave-type-badge",style:{backgroundColor:"#e3f2fd",color:"#1976d2",padding:"2px 6px",borderRadius:"12px",fontSize:"11px",fontWeight:"500",width:"fit-content"},children:e.leaveType}),Number(e.days)===.5&&t.jsxs("small",{style:{color:"#555"},children:["Half Day ",e.partOfDay?`(${e.partOfDay})`:""]})]})}),t.jsx("td",{style:{fontSize:"12px"},children:u(e.startDate)}),t.jsx("td",{style:{fontSize:"12px"},children:u(e.endDate)}),t.jsx("td",{style:{textAlign:"center"},children:t.jsx("strong",{style:{fontSize:"14px",color:"#1976d2"},children:e.days})}),t.jsx("td",{style:{fontSize:"12px",maxWidth:"200px",wordWrap:"break-word"},children:e.reason}),t.jsx("td",{children:t.jsx("span",{className:"status-badge",style:{backgroundColor:H(e.status),color:"white",textTransform:"capitalize",padding:"4px 8px",borderRadius:"4px",fontSize:"11px",fontWeight:"500"},children:e.status.replace("_"," ")})}),t.jsx("td",{style:{fontSize:"12px"},children:e.projectManager||e.approvedBy||"-"}),t.jsx("td",{children:t.jsxs("div",{style:{display:"flex",gap:4,flexDirection:"column",alignItems:"stretch"},children:[(e.status==="pending"||e.status==="manager_pending"||e.status==="admin_pending")&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"btn-primary",onClick:()=>N(e.id,"approved"),style:{fontSize:"10px",padding:"3px 6px",minHeight:"24px"},children:"Approve"}),t.jsx("button",{className:"btn-outline",onClick:()=>N(e.id,"rejected"),style:{fontSize:"10px",padding:"3px 6px",minHeight:"24px"},children:"Reject"})]}),t.jsx("button",{className:"btn-outline",onClick:()=>I(e.id),style:{fontSize:"10px",padding:"3px 6px",minHeight:"24px",color:"#dc3545"},children:"Delete"})]})})]},e.id))})]})})]})}export{te as default};
