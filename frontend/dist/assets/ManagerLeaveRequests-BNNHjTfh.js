import{L as V,F as i,E as e}from"./vendor-AZjfysqh.js";import{f as j}from"./date-DAJMpUuB.js";import{g as G}from"./holidays-BHBlvUOY.js";import{u as J}from"./index-CcBKZM2H.js";import"./router-CieCW4vl.js";function Z(){const{currentUser:o,getMyLeaves:M,getMyLeaveBalance:Y,createLeave:O}=J(),A=V(),[b,D]=i.useState([]),[u,H]=i.useState(0),[I,T]=i.useState(18),[P,C]=i.useState(18),[v,x]=i.useState("history"),[f,y]=i.useState(!1),[n,c]=i.useState({leaveType:"Sick Leave",startDate:"",endDate:"",reason:"",isHalfDay:!1,partOfDay:"AM"}),[k,E]=i.useState(!1),L=new Date,B=L.toLocaleString("default",{month:"long"}),R=G(L.getFullYear(),L.getMonth()),p=1.5;i.useEffect(()=>{N(),w()},[o]),i.useEffect(()=>{new URLSearchParams(A.search||"").get("section")==="holidays"&&(y(!1),x("holidays"))},[A.search]),i.useEffect(()=>{const a=setInterval(()=>{w(),N()},5e3);return()=>clearInterval(a)},[o]);const N=async()=>{if(!(o!=null&&o.email)){D([]);return}try{const t=(await M()||[]).map(s=>({id:s.id,leaveType:s.type||"Leave",startDate:s.from,endDate:s.to,days:s.duration!=null?Number(s.duration):q(String(s.from).slice(0,10),String(s.to).slice(0,10)),status:String(s.status||"").toLowerCase(),approvedBy:s.approverEmail||"",approvedAt:s.updatedAt||s.createdAt,createdAt:s.createdAt}));D(t)}catch(a){console.warn("Failed to load leave history",a),D([])}},w=async()=>{if(!(o!=null&&o.email))return;const a=new Date().getMonth(),t=new Date().getFullYear();try{const s=await M(),h=l=>{if(l&&l.duration!=null){const r=Number(l.duration);return isNaN(r)?0:Math.max(.5,r)}return q(String(l.from).slice(0,10),String(l.to).slice(0,10))},S=(s||[]).filter(l=>{const r=String(l.status||"").toLowerCase();return r==="approved"||r==="pending"}),F=(s||[]).filter(l=>String(l.status||"").toLowerCase()==="approved"),z=S.filter(l=>{const r=new Date(l.from);return r.getMonth()===a&&r.getFullYear()===t}).reduce((l,r)=>l+h(r),0);H(z);const g=F.filter(l=>new Date(l.from).getFullYear()===t).reduce((l,r)=>l+h(r),0);let d=18,m=Math.max(0,d-g);try{const l=await Y(t);l&&typeof l.annualAllowance<"u"&&(d=Number(l.annualAllowance)),l&&typeof l.remaining<"u"?m=Number(l.remaining):m=Math.max(0,d-g)}catch{m=Math.max(0,d-g)}T(isNaN(d)?18:d),C(isNaN(m)?Math.max(0,(isNaN(d)?18:d)-g):m)}catch(s){console.warn("Failed to compute monthly leaves",s),H(0),T(18),C(18)}},q=(a,t)=>{if(!a||!t)return 0;const s=new Date(a),h=new Date(t);if(a===t)return 1;const S=Math.abs(h-s);return Math.ceil(S/(1e3*60*60*24))+1},_=async a=>{if(a.preventDefault(),!n.startDate||!n.endDate||!n.reason){alert("Please fill in all required fields");return}if(n.isHalfDay&&n.startDate!==n.endDate){alert("For half day, Start and End date must be the same.");return}try{E(!0);const t={from:new Date(n.startDate).toISOString(),to:new Date(n.endDate).toISOString(),type:n.isHalfDay?"half-day":n.leaveType,reason:n.reason};n.isHalfDay&&(t.duration=.5,t.partOfDay=n.partOfDay||"AM"),await O(t),alert("Leave request submitted successfully"),y(!1),c({leaveType:"Sick Leave",startDate:"",endDate:"",reason:"",isHalfDay:!1,partOfDay:"AM"}),await N(),await w(),x("history")}catch(t){alert((t==null?void 0:t.message)||"Failed to submit leave request")}finally{E(!1)}},$=(b||[]).filter(a=>a.status==="pending"||a.status==="manager_pending"||a.status==="admin_pending");return e.jsxs("div",{className:"dashboard fade-in",children:[e.jsx("h2",{children:"ðŸ–ï¸ Leave History"}),e.jsxs("div",{className:"dashboard-grid",style:{marginBottom:"20px"},children:[e.jsxs("div",{className:"dashboard-card stats-card",style:{background:u>=p?"#f8d7da":"#d4edda"},children:[e.jsx("h3",{style:{color:u>=p?"#721c24":"#155724"},children:"ðŸ“… Monthly Leaves"}),e.jsxs("p",{style:{color:u>=p?"#721c24":"#155724"},children:[u," / ",p]}),u>=p&&e.jsx("small",{style:{color:"#721c24",textAlign:"center",marginTop:10},children:"Limit reached - Team Lead approval required"})]}),e.jsxs("div",{className:"dashboard-card stats-card",style:{background:"#fff3cd"},children:[e.jsx("h3",{style:{color:"#856404"},children:"ðŸ“‹ Yearly Leaves"}),e.jsxs("p",{style:{color:"#856404"},children:[P," / ",I]})]}),e.jsxs("div",{className:"dashboard-card stats-card",style:{background:"#d1ecf1"},children:[e.jsx("h3",{style:{color:"#0c5460"},children:"â³ Pending"}),e.jsx("p",{style:{color:"#0c5460"},children:$.filter(a=>a.status==="pending"||a.status==="manager_pending").length})]})]}),e.jsxs("div",{className:"dashboard-actions",style:{marginBottom:12},children:[e.jsx("button",{className:v==="history"&&!f?"btn-primary":"btn-outline",onClick:()=>x("history"),type:"button",children:"Leave History"}),e.jsx("button",{className:f?"btn-primary":"btn-outline",onClick:()=>y(!0),type:"button",children:"Leave Request"}),e.jsx("button",{className:v==="holidays"&&!f?"btn-primary":"btn-outline",onClick:()=>x("holidays"),type:"button",children:"Holidays"})]}),f&&e.jsx("div",{className:"modal-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"modal leave-modal",style:{width:"min(760px, 96%)"},children:[e.jsxs("div",{className:"leave-modal-header",style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:10},children:[e.jsx("h3",{style:{margin:0},children:"ðŸ“ Leave Request"}),e.jsx("button",{type:"button",className:"btn-outline",onClick:()=>y(!1),style:{padding:"6px 10px"},children:"Close"})]}),e.jsxs("form",{onSubmit:_,style:{marginTop:14},children:[e.jsxs("div",{className:"leave-modal-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:12},children:[e.jsxs("div",{children:[e.jsx("label",{children:"Leave Type"}),e.jsxs("select",{value:n.leaveType,onChange:a=>c({...n,leaveType:a.target.value}),disabled:n.isHalfDay,children:[e.jsx("option",{value:"Sick Leave",children:"Sick Leave"}),e.jsx("option",{value:"Casual Leave",children:"Casual Leave"}),e.jsx("option",{value:"Annual Leave",children:"Annual Leave"}),e.jsx("option",{value:"Emergency Leave",children:"Emergency Leave"})]})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Start Date *"}),e.jsx("input",{type:"date",value:n.startDate,onChange:a=>{const t=a.target.value;c(s=>({...s,startDate:t,endDate:s.isHalfDay?t:s.endDate}))},required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{children:"End Date *"}),e.jsx("input",{type:"date",value:n.endDate,onChange:a=>c({...n,endDate:a.target.value}),min:n.startDate||void 0,disabled:n.isHalfDay,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{children:"Half Day"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginTop:6},children:[e.jsx("input",{type:"checkbox",checked:n.isHalfDay,onChange:a=>{const t=a.target.checked;c(s=>({...s,isHalfDay:t,endDate:t&&s.startDate||s.endDate}))}}),e.jsx("span",{children:"Request 0.5 day"})]})]}),n.isHalfDay&&e.jsxs("div",{children:[e.jsx("label",{children:"Part of Day"}),e.jsxs("select",{value:n.partOfDay,onChange:a=>c({...n,partOfDay:a.target.value}),children:[e.jsx("option",{value:"AM",children:"AM"}),e.jsx("option",{value:"PM",children:"PM"})]})]})]}),e.jsxs("div",{className:"leave-modal-reason",style:{marginTop:12},children:[e.jsx("label",{children:"Reason *"}),e.jsx("textarea",{rows:3,value:n.reason,onChange:a=>c({...n,reason:a.target.value}),placeholder:"Please provide reason for leave...",required:!0})]}),e.jsxs("div",{className:"leave-modal-actions",style:{display:"flex",gap:10,marginTop:14,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",className:"btn-outline",onClick:()=>y(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"btn-primary",disabled:k,children:k?"Submitting...":"Submit"})]})]})]})}),v==="history"&&e.jsxs("div",{className:"dashboard-card",children:[e.jsx("h3",{children:"ðŸ“š Leave History"}),b.length===0?e.jsx("p",{style:{textAlign:"center",color:"#6c757d"},children:"No leave history found."}):e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"user-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Dates"}),e.jsx("th",{children:"Days"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Approved By"}),e.jsx("th",{children:"Approved Date"})]})}),e.jsx("tbody",{children:b.sort((a,t)=>new Date(t.approvedAt)-new Date(a.approvedAt)).map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("span",{className:`status-badge ${a.leaveType.toLowerCase().replace(" ","-")}`,children:a.leaveType})}),e.jsxs("td",{children:[j(a.startDate)," - ",j(a.endDate)]}),e.jsx("td",{children:e.jsx("strong",{children:a.days})}),e.jsx("td",{children:(()=>{const t=String(a.status||"").toLowerCase(),s=t==="approved"?"approved":t==="rejected"?"rejected":"pending",h=t?t.charAt(0).toUpperCase()+t.slice(1):"Pending";return e.jsx("span",{className:`status-badge leave-status ${s}`,children:h})})()}),e.jsx("td",{children:a.approvedBy||"-"}),e.jsx("td",{children:j(a.approvedAt)})]},a.id))})]})})]}),v==="holidays"&&e.jsxs("div",{className:"dashboard-card",style:{background:"#eef2ff"},children:[e.jsxs("h3",{style:{color:"#1e3a8a"},children:["ðŸŽ‰ Holidays in ",B]}),R.length>0?e.jsx("div",{style:{marginTop:8,maxHeight:260,overflowY:"auto",paddingRight:6},children:R.map((a,t)=>e.jsxs("div",{style:{padding:"8px 10px",margin:"6px 0",background:"linear-gradient(90deg, rgba(99, 102, 241, 0.14), rgba(239, 246, 255, 0.75))",borderLeft:"5px solid #6366f1",borderRadius:10,fontSize:14,color:"#1e3a8a"},children:[e.jsx("strong",{children:j(a.date)})," â€“ ",a.name]},`${a.date}-${t}`))}):e.jsx("p",{style:{marginTop:8,color:"#1e3a8a"},children:"No holidays this month."})]})]})}export{Z as default};
