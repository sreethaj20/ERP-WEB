import{M as z,L as P,F as p,E as r,Z as $}from"./vendor-AZjfysqh.js";import{a as B}from"./index-CcBKZM2H.js";import"./router-CieCW4vl.js";function V(){const v=z(),S=P(),A=(()=>{try{const e=localStorage.getItem("erpUser");return e?String(JSON.parse(e).email||"").toLowerCase():""}catch{return""}})(),I=!!A,n=e=>A?`${e}_${A}`:e,[b,j]=p.useState(!1),[L,c]=p.useState(""),[m,x]=p.useState(localStorage.getItem(n("leaveStatus"))||""),[R,C]=p.useState(null),[f,T]=p.useState({shiftName:"Morning Shift",loginWindow:{start:"09:00",end:"09:10"},currentTime:new Date().toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})}),O=p.useRef(m),k=p.useRef(!1),d=p.useRef(null);p.useEffect(()=>{O.current=m},[m]),p.useEffect(()=>{var a;if((a=S.state)!=null&&a.shiftInfo){const{shiftType:t,loginWindow:o}=S.state.shiftInfo;T({shiftName:t||"Morning Shift",loginWindow:{start:(o==null?void 0:o.start)||"09:00",end:(o==null?void 0:o.end)||"09:10"},currentTime:new Date().toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})})}try{if(localStorage.getItem("lastExtensionRejectedAt")){try{alert("Your late login (shift extension) request was previously rejected by your Team Lead.")}catch{}localStorage.removeItem("lastExtensionRejectedAt"),localStorage.removeItem("lastExtensionRejectedEmail")}}catch{}try{const t=new Date().toISOString().slice(0,10);localStorage.getItem(n("lastHalfDayDate"))!==t&&(localStorage.removeItem(n("leaveStatus")),localStorage.removeItem(n("leaveApprovalTime")),localStorage.removeItem(n("halfDayLogoutAfter")),localStorage.removeItem("leaveStatus"),localStorage.removeItem("leaveApprovalTime"),localStorage.removeItem("halfDayLogoutAfter"),x("")),localStorage.setItem(n("lastHalfDayDate"),t)}catch{}const e=localStorage.getItem(n("leaveApprovalTime"));if(e){const t=new Date(e),o=new Date;if((o-t)/(1e3*60*60)<4){const h=144e5-(o-t);q(h),x("approved"),c("Leave approved. Redirecting..."),setTimeout(()=>{I?w():v("/login")},1200)}else localStorage.removeItem(n("leaveStatus")),localStorage.removeItem(n("leaveApprovalTime"))}},[S.state]);const w=()=>{try{const e=localStorage.getItem("erpUser"),a=e?JSON.parse(e):null,t=B(a)||"/";v(t)}catch{v("/")}},D=()=>{if(!k.current){k.current=!0,c("Extension request was rejected. Redirecting to login...");try{alert("Your late login request was rejected by your Team Lead. You will be redirected to the login screen.")}catch{}try{const e=localStorage.getItem("erpUser"),a=e&&JSON.parse(e).email||"";localStorage.setItem("lastExtensionRejectedAt",new Date().toISOString()),a&&localStorage.setItem("lastExtensionRejectedEmail",String(a).toLowerCase())}catch{}try{fetch("/api/auth/logout-clear",{method:"POST",credentials:"include"}).catch(()=>{})}catch{}try{localStorage.removeItem("erpUser"),localStorage.removeItem("erpToken")}catch{}setTimeout(()=>v("/login"),300)}},E=async()=>{try{if(!I)return;const e=await fetch("/api/shift-requests/my",{credentials:"include"});if(!e.ok)return;const a=await e.json();if(Array.isArray(a)&&a.length){const t=[...a].sort((i,h)=>new Date(h.updatedAt||h.createdAt||0)-new Date(i.updatedAt||i.createdAt||0))[0],o=String(t.status||"").toLowerCase();o==="approved"?(c("Extension approved! Redirecting to your home page..."),setTimeout(w,1200),d.current&&(clearInterval(d.current),d.current=null)):o==="rejected"?(D(),d.current&&(clearInterval(d.current),d.current=null)):c("Latest extension status: "+o)}}catch{}};p.useEffect(()=>{if(!I)return;let e=!1;const a=async()=>{try{const o=await fetch("/api/shift-requests/my",{credentials:"include"});if(!o.ok)return;const i=await o.json();if(Array.isArray(i)&&i.length){const h=[...i].sort((u,g)=>new Date(g.updatedAt||g.createdAt||0)-new Date(u.updatedAt||u.createdAt||0))[0],l=String(h.status||"").toLowerCase();l==="approved"?(c("Extension approved! Redirecting to your home page..."),e=!0,setTimeout(w,1500)):l==="rejected"&&(e=!0,D())}}catch{}},t=setInterval(()=>{e||a()},15e3);return a(),()=>clearInterval(t)},[I]);const H=async()=>{j(!0),c("Sending half-day leave request...");try{const e=new Date().toISOString().split("T")[0],a=await fetch("/api/leaves",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({from:e,to:e,type:"half-day",reason:"Late login - Half day leave requested",duration:.5,partOfDay:"AM"})}),t=await a.json();if(!a.ok)throw new Error(t.message||"Failed to submit leave request");x("pending"),localStorage.setItem(n("leaveStatus"),"pending");try{const l=new Date().toISOString().slice(0,10);localStorage.setItem(n("lastHalfDayDate"),l)}catch{}c("Half-day leave request submitted. Waiting for approval...");const o=async()=>{try{const l=await fetch("/api/leaves/my",{credentials:"include"});if(!l.ok)throw new Error("Failed to fetch leave status");const u=await l.json(),g=Array.isArray(u)?u.sort((y,W)=>new Date(W.createdAt)-new Date(y.createdAt))[0]:null;if((g==null?void 0:g.status)==="approved"){x("approved"),localStorage.setItem(n("leaveStatus"),"approved"),localStorage.setItem(n("leaveApprovalTime"),new Date().toISOString());try{const y=Date.now()+144e5;localStorage.setItem(n("halfDayLogoutAfter"),String(y)),localStorage.setItem("halfDayLogoutAfter",String(y))}catch{}try{const y=new Date().toISOString().slice(0,10);localStorage.setItem(n("lastHalfDayDate"),y)}catch{}return c("Leave approved! Redirecting to your home page..."),q(4*60*60*1e3),setTimeout(w,1500),!0}else if((g==null?void 0:g.status)==="rejected")return x("rejected"),localStorage.setItem(n("leaveStatus"),"rejected"),D(),!0}catch(l){console.error("Error checking leave status:",l)}return!1},i=setInterval(async()=>{await o()&&clearInterval(i)},15e3);return(async()=>{await o()&&clearInterval(i)})(),()=>clearInterval(i)}catch(e){console.error("Leave request error:",e),c(e.message||"Failed to submit leave request")}finally{j(!1)}},q=e=>{const a=Date.now()+e,t=()=>{const i=Math.max(0,a-Date.now()),h=Math.floor(i/(1e3*60*60)),l=Math.floor(i%(1e3*60*60)/(1e3*60));C(`${h}h ${l}m`),i<=0&&(clearInterval(o),c("You can now log out."),C(null))};t();const o=setInterval(t,6e4);return()=>clearInterval(o)},M=async()=>{var e,a;try{j(!0),c("Sending shift extension request...");let t="";try{const g=localStorage.getItem("erpUser");g&&(t=(JSON.parse(g).email||"").toLowerCase())}catch{}!t&&((a=(e=S==null?void 0:S.state)==null?void 0:e.shiftInfo)!=null&&a.email)&&(t=String(S.state.shiftInfo.email).toLowerCase());const o={email:t||void 0,shiftType:f.shiftName,requestedMinutes:30,reason:`Late login. Allowed ${f.loginWindow.start}-${f.loginWindow.end}, current ${f.currentTime}`},l=await fetch("/api/shift-requests/public",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),u=await l.json().catch(()=>({}));if(!l.ok)throw new Error((u==null?void 0:u.message)||(u==null?void 0:u.error)||"Failed to create shift extension request");c("Shift extension request submitted to your team lead.");try{localStorage.removeItem(n("leaveStatus")),localStorage.removeItem(n("leaveApprovalTime")),localStorage.removeItem(n("halfDayLogoutAfter")),localStorage.removeItem("leaveStatus"),localStorage.removeItem("leaveApprovalTime"),localStorage.removeItem("halfDayLogoutAfter")}catch{}}catch(t){c((t==null?void 0:t.message)||"Failed to submit request")}finally{j(!1)}},N=async()=>{try{T(e=>({...e,currentTime:new Date().toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})})),d.current&&(clearInterval(d.current),d.current=null),await E(),d.current=setInterval(async()=>{T(e=>({...e,currentTime:new Date().toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1})})),await E()},1e4)}catch{}};p.useEffect(()=>()=>{d.current&&(clearInterval(d.current),d.current=null)},[]);const U=()=>{m==="approved"?w():v("/login")};return r.jsx("div",{style:s.container,children:r.jsxs("div",{style:s.card,children:[r.jsxs("div",{style:s.header,children:[r.jsx($,{size:24,style:s.clockIcon}),r.jsx("h2",{style:s.title,children:"Shift Login Blocked"})]}),r.jsxs("div",{style:s.errorMessage,children:["Login window closed for ",f.shiftName,". Allowed login: ",f.loginWindow.start," - ",f.loginWindow.end,". Current: ",f.currentTime]}),r.jsxs("div",{style:s.infoRow,children:[r.jsx("span",{style:s.infoLabel,children:"Allowed login window:"}),r.jsxs("span",{style:s.infoValue,children:[f.loginWindow.start," - ",f.loginWindow.end]})]}),r.jsxs("div",{style:s.infoRow,children:[r.jsx("span",{style:s.infoLabel,children:"Current server time:"}),r.jsx("span",{style:s.infoValue,children:f.currentTime})]}),r.jsxs("div",{style:s.buttonGroup,children:[r.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:r.jsx("button",{style:{...s.button,backgroundColor:"#6b7280",padding:"8px 12px",fontSize:14},onClick:N,disabled:b,children:"â†» Refresh"})}),r.jsx("button",{style:s.button,onClick:H,disabled:b||m==="pending"||m==="approved",children:m==="pending"?"Request Pending...":m==="approved"?"Leave Approved":"Apply Half-Day Leave"}),r.jsx("button",{style:{...s.button,backgroundColor:"#3b82f6"},onClick:M,disabled:b||m==="approved",children:"Request Shift Extension"}),r.jsx("button",{style:{...s.button,backgroundColor:"#4b5563"},onClick:U,disabled:b,children:m==="approved"?"Continue to Home":"Back to Login"})]}),R&&r.jsxs("p",{style:{color:"#666",marginTop:"10px",textAlign:"center"},children:["Logout available in: ",R]}),r.jsx("p",{style:s.note,children:"Applying a half-day leave will mark your attendance for the day. Requesting extension will notify your manager to approve a late login."}),L&&r.jsx("p",{style:s.message,children:L})]})})}const s={header:{display:"flex",alignItems:"center",marginBottom:"16px",gap:"8px"},clockIcon:{color:"#ef4444"},errorMessage:{backgroundColor:"#fef2f2",color:"#dc2626",padding:"12px",borderRadius:"4px",marginBottom:"16px",fontSize:"14px",fontWeight:"500"},infoRow:{display:"flex",justifyContent:"space-between",marginBottom:"12px",fontSize:"14px"},infoLabel:{color:"#4b5563"},infoValue:{fontWeight:"500"},buttonGroup:{display:"flex",flexDirection:"column",gap:"12px",margin:"24px 0"},note:{fontSize:"13px",color:"#6b7280",textAlign:"center",marginTop:"16px",lineHeight:"1.5"},container:{width:"100%",minHeight:"100vh",backgroundColor:"#f3f4f6",display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"},card:{width:"100%",maxWidth:"500px",padding:"30px",backgroundColor:"white",borderRadius:"12px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)"},title:{fontSize:"24px",fontWeight:"600",margin:"0",color:"#1f2937"},button:{padding:"12px 20px",borderRadius:"8px",border:"none",backgroundColor:"#10b981",color:"white",fontWeight:"600",cursor:"pointer",transition:"background-color 0.2s",fontSize:"16px"},message:{marginTop:"16px",padding:"12px",borderRadius:"8px",backgroundColor:"#f0fdf4",color:"#065f46",textAlign:"center",fontSize:"14px"}};export{V as default};
