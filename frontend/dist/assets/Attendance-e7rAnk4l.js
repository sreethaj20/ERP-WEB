import{F as r,E as e}from"./vendor-AZjfysqh.js";import{i as te}from"./holidays-BHBlvUOY.js";import{u as se}from"./index-CcBKZM2H.js";import"./router-CieCW4vl.js";function re(){const{users:W,currentUser:n,logAttendance:q,getAttendanceByDate:F,getAttendanceForUser:L}=se(),[x,G]=r.useState(()=>new Date().toISOString().split("T")[0]),[m,K]=r.useState(()=>new Date().toISOString().slice(0,7)),[R,Q]=r.useState(!1),[v,D]=r.useState(""),[g,M]=r.useState(()=>new Date().toISOString().split("T")[0]),[h,B]=r.useState("Present"),[I,P]=r.useState("09:00:00"),[O,T]=r.useState({}),[$,H]=r.useState(0),[V,E]=r.useState([]),[ne,Y]=r.useState(!1),b=r.useMemo(()=>n?[n]:[],[n]);r.useEffect(()=>{n!=null&&n.email&&D(n.email)},[n]);const C=t=>{const s=((t==null?void 0:t.empId)||((t==null?void 0:t.email)||"").split("@")[0]||"").toString().toUpperCase();return s.includes("-")?s.split("-")[0]:s},J=t=>{const s=W.find(l=>(l.email||"").toLowerCase()===String(t||"").toLowerCase()),a=String((s==null?void 0:s.designation)||"").toLowerCase();return a==="developer"||a.includes("developer")},A=(t,s)=>{const a=(s instanceof Date?s:new Date(s)).getDay();return J(t)?a===0||a===6:a===3};r.useEffect(()=>{(async()=>{try{const s=await F(x),a={};(s||[]).forEach(i=>{a[(i.email||"").toLowerCase()]=i});const l={};b.forEach(i=>{const w=(i.email||"").toLowerCase(),o=a[w],p=new Date(x),y=new Date,u=k=>k.toISOString().slice(0,10),f=A(i.email,p);let c=(o==null?void 0:o.status)||"Not Marked",j=(o==null?void 0:o.hours)??"8";o||(f?(c="Week Off",j="0"):u(p)<u(y)?(c="Absent",j="0"):u(p)===u(y)&&(c="Not Marked",j="0")),l[i.email]={status:c,hours:j}}),T(l)}catch{const s={};filteredEmployees.forEach(a=>{s[a.email]={status:"Not Marked",hours:"0"}}),T(s)}})()},[W,x,b,$,F]),r.useEffect(()=>{const t=()=>H(s=>s+1);return window.addEventListener("erp-attendance-updated",t),window.addEventListener("storage",t),()=>{window.removeEventListener("erp-attendance-updated",t),window.removeEventListener("storage",t)}},[]);const X=t=>{if(!t)return 0;const[s,a]=String(t).split(":");return parseInt(s||"0",10)*60+parseInt(a||"0",10)},z=t=>{const s=Math.floor(Math.max(0,t)/60),a=Math.max(0,t)%60,l=i=>String(i).padStart(2,"0");return`${l(s)}:${l(a)}`},Z=t=>{try{if(!t)return 0;const s=String(t).split(":"),a=Number(s[0]||0),l=Number(s[1]||0),i=Number(s[2]||0);return a+l/60+i/3600}catch{return 0}},S=(t,s)=>({display:"inline-block",padding:"2px 10px",borderRadius:999,background:t,color:s,fontWeight:600,minWidth:36,textAlign:"center"}),_=t=>t>=85?["#DCFCE7","#065F46"]:t>=60?["#FEF3C7","#92400E"]:["#FEE2E2","#B91C1C"];r.useEffect(()=>{(async()=>{if(!(n!=null&&n.email)){E([]);return}Y(!0);try{const s=await L(n.email),a=String(m).slice(0,7),l=(Array.isArray(s)?s:[]).filter(d=>String(d.date||"").startsWith(a)),i=l.filter(d=>String(d.status).toLowerCase()==="present"),w=l.filter(d=>String(d.status).toLowerCase()==="absent"),o=l.filter(d=>String(d.status).toLowerCase()==="leave"),p=i.reduce((d,N)=>d+X(N.hours),0),y=new Date(a+"-01"),u=new Date(y.getFullYear(),y.getMonth()+1,0),f=n!=null&&n.dateOfJoining?new Date(n.dateOfJoining):null;let c=0;for(let d=new Date(y);d<=u;d.setDate(d.getDate()+1)){const N=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;f&&d<new Date(f.getFullYear(),f.getMonth(),f.getDate())||A(n.email,d)||te(N)||c++}const j=i.length>0?Math.round(p/i.length):0,k=[{email:n.email,empId:C(n),name:`${n.firstName||""} ${n.lastName||""}`.trim()||n.username||n.email,department:n.department||"-",present:i.length,absent:w.length,leave:o.length,hours:z(p),workingDays:c,attendanceRate:c?Math.round(i.length/c*100):0,avgPerDay:z(j)}];E(k)}catch{E([])}finally{Y(!1)}})()},[n==null?void 0:n.email,m,$,L]);const U=async()=>{if(!v){alert("Please select an EMP ID");return}if(!g){alert("Please select a date");return}if(A(v,new Date(g))){alert(J(v)?"Saturday/Sunday are weekly off for Developers.":"Wednesday is a weekly off.");return}const t=l=>l instanceof Date?l.toISOString().slice(0,10):String(l).slice(0,10);if(!(t(g)<t(new Date))&&String(h)!=="Leave"){alert("You can update attendance only for past dates (except Leave).");return}let a=Z(I);h==="Present"&&a<9&&(a=9),(h==="Absent"||h==="Leave")&&(a=0),await q({email:v,date:g,status:h,hours:a}),alert(`Saved ${h} for ${g}`),H(l=>l+1)},ee=()=>{D(""),M(x),B("Present"),P("09:00:00")};return((n==null?void 0:n.role)||"").toLowerCase()!=="admin"?e.jsxs("div",{className:"dashboard fade-in",style:{padding:20},children:[e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"This page is restricted to Admins."})]}):e.jsxs("div",{className:"dashboard fade-in",children:[e.jsx("h2",{children:"Admin Attendance"}),e.jsx("p",{children:"Update daily attendance and view monthly overview."}),e.jsxs("div",{style:{display:"flex",alignItems:"flex-end",gap:"20px",flexWrap:"wrap",marginBottom:"20px"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[e.jsx("label",{style:{marginBottom:"5px",fontSize:"14px",fontWeight:"bold"},children:"Select Date (for daily actions):"}),e.jsx("input",{type:"date",value:x,onChange:t=>{G(t.target.value),M(t.target.value)},style:{padding:"8px",border:"1px solid #ddd",borderRadius:"4px"}})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[e.jsx("label",{style:{marginBottom:"5px",fontSize:"14px",fontWeight:"bold"},children:"Select Month (for overview):"}),e.jsx("input",{type:"month",value:m,onChange:t=>K(t.target.value),style:{padding:"8px",border:"1px solid #ddd",borderRadius:"4px"}})]}),e.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[e.jsx("label",{style:{marginBottom:"5px",fontSize:"14px",fontWeight:"bold"},children:"Day-wise Preview"}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("input",{type:"checkbox",checked:R,onChange:t=>Q(t.target.checked)}),e.jsx("span",{children:"Show Selected Date Table"})]})]})]}),e.jsxs("div",{className:"dashboard-card",style:{padding:16,marginBottom:16,borderRadius:10},children:[e.jsx("h3",{style:{marginTop:0,marginBottom:10},children:"Manual Attendance Update"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:12},children:[e.jsxs("div",{style:{minWidth:220},children:[e.jsx("label",{style:{fontWeight:600},children:"Select EMP ID"}),e.jsx("select",{value:v,onChange:t=>D(t.target.value),style:{padding:"8px",border:"1px solid #ddd",borderRadius:"4px",width:"100%"},children:b.map(t=>e.jsx("option",{value:t.email,children:C(t)},t.email))})]}),e.jsxs("div",{style:{minWidth:200},children:[e.jsx("label",{style:{fontWeight:600},children:"Date"}),e.jsx("input",{type:"date",value:g,onChange:t=>M(t.target.value),style:{padding:"8px",border:"1px solid #ddd",borderRadius:"4px",width:"90%"}})]}),e.jsxs("div",{style:{minWidth:200},children:[e.jsx("label",{style:{fontWeight:600},children:"Status"}),e.jsxs("select",{value:h,onChange:t=>B(t.target.value),style:{padding:"8px",border:"1px solid #ddd",borderRadius:"4px",width:"100%"},children:[e.jsx("option",{value:"Present",children:"Present"}),e.jsx("option",{value:"Absent",children:"Absent"}),e.jsx("option",{value:"Leave",children:"Leave"})]})]}),e.jsxs("div",{style:{minWidth:200},children:[e.jsx("label",{style:{fontWeight:600},children:"Hours Worked"}),e.jsx("input",{type:"time",step:"1",value:I,onChange:t=>P(t.target.value),disabled:h!=="Present",style:{padding:"8px",border:"1px solid #ddd",borderRadius:"4px",width:"90%"}})]}),e.jsxs("div",{style:{display:"flex",gap:12,justifyContent:"flex-start",gridColumn:"1 / -1",marginTop:8},children:[e.jsx("button",{className:"btn-primary",onClick:U,style:{minWidth:96},children:"Save"}),e.jsx("button",{className:"btn",onClick:ee,style:{border:"1px solid #d1d5db",minWidth:96},children:"Reset"})]})]})]}),R&&e.jsxs("div",{className:"dashboard-card",style:{marginBottom:16,borderRadius:10},children:[e.jsxs("h3",{style:{marginTop:0},children:["Selected Date: ",x]}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"user-table",style:{width:"100%"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"14%"},children:"Emp ID"}),e.jsx("th",{style:{width:"24%"},children:"Emp Name"}),e.jsx("th",{style:{width:"14%"},children:"Status"}),e.jsx("th",{style:{width:"14%"},children:"Hours"})]})}),e.jsx("tbody",{children:b.map(t=>{const s=O[t.email]||{status:"Not Marked",hours:"0"},a=C(t),l=`${t.firstName||""} ${t.lastName||""}`.trim()||t.username||t.email;return e.jsxs("tr",{style:{borderBottom:"#e5e7eb 1px solid"},children:[e.jsx("td",{style:{padding:"8px 10px"},children:a}),e.jsx("td",{style:{padding:"8px 10px"},children:l}),e.jsx("td",{style:{padding:"8px 10px"},children:s.status}),e.jsx("td",{style:{padding:"8px 10px"},children:typeof s.hours=="number"?`${s.hours}:00`:s.hours||"0"})]},`day-${t.email}`)})})]})})]}),(()=>{const t=(n==null?void 0:n.dateOfJoining)||"",s=t?new Date(t):null,a=s?s.toISOString().slice(0,7):null;return(a?String(m).slice(0,7)<a:!1)?e.jsxs("div",{className:"dashboard-card",style:{marginBottom:16,borderRadius:10,padding:16,background:"#f8fafc"},children:[e.jsxs("h3",{style:{marginTop:0},children:["ðŸ“… Attendance Overview â€” ",new Date(m+"-01").toLocaleString(void 0,{month:"long",year:"numeric"})]}),e.jsxs("p",{style:{margin:0,color:"#334155"},children:["Attendance details are not available before your Date of Joining (",a,")."]})]}):e.jsxs("div",{className:"dashboard-card",style:{marginBottom:16,borderRadius:10},children:[e.jsxs("h3",{style:{marginTop:0,paddingBottom:10,borderBottom:"1px solid #e5e7eb"},children:["ðŸ“… Attendance Overview â€” ",new Date(m+"-01").toLocaleString(void 0,{month:"long",year:"numeric"})]}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"user-table",style:{width:"100%"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{background:"#eef2ff"},children:[e.jsx("th",{style:{width:"20%"},children:"Employee"}),e.jsx("th",{style:{width:"14%"},children:"Department"}),e.jsx("th",{style:{width:"10%"},children:"Working Days"}),e.jsx("th",{style:{width:"10%"},children:"Present Days"}),e.jsx("th",{style:{width:"10%"},children:"Leave Days"}),e.jsx("th",{style:{width:"10%"},children:"Absent Days"}),e.jsx("th",{style:{width:"10%"},children:"Attendance Rate"}),e.jsx("th",{style:{width:"10%"},children:"Avg Time/Day"}),e.jsxs("th",{style:{width:"12%"},children:[x," Status"]})]})}),e.jsx("tbody",{children:V.map(i=>{const w=O[(n==null?void 0:n.email)||""]||{status:"Not Marked"};return e.jsxs("tr",{style:{borderBottom:"#e5e7eb 1px solid"},children:[e.jsxs("td",{style:{padding:"10px 12px"},children:[e.jsx("div",{style:{fontWeight:600},children:i.name}),e.jsx("div",{style:{color:"#6b7280",fontSize:12},children:i.empId})]}),e.jsx("td",{style:{padding:"10px 12px"},children:i.department}),e.jsx("td",{style:{padding:"10px 12px",textAlign:"center"},children:i.workingDays}),e.jsx("td",{style:{padding:"10px 12px",textAlign:"center"},children:e.jsx("span",{style:S("#DCFCE7","#065F46"),children:i.present})}),e.jsx("td",{style:{padding:"10px 12px",textAlign:"center"},children:e.jsx("span",{style:S("#FEF3C7","#92400E"),children:i.leave})}),e.jsx("td",{style:{padding:"10px 12px",textAlign:"center"},children:e.jsx("span",{style:S("#FEE2E2","#B91C1C"),children:i.absent})}),e.jsx("td",{style:{padding:"10px 12px",textAlign:"center"},children:(()=>{const[o,p]=_(i.attendanceRate||0);return e.jsxs("span",{style:S(o,p),children:[i.attendanceRate,"%"]})})()}),e.jsx("td",{style:{padding:"10px 12px",fontFamily:'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',textAlign:"center"},children:i.avgPerDay}),e.jsx("td",{style:{padding:"10px 12px"},children:w.status})]},`mon-${i.email}`)})})]})})]})})()]})}export{re as default};
