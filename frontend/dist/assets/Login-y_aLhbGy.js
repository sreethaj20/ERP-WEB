import{M as C,F as i,E as o}from"./vendor-AZjfysqh.js";import{u as R}from"./index-CcBKZM2H.js";import{L as q}from"./router-CieCW4vl.js";function B({data:l,email:y,onClose:d}){const{createLeave:p,createNotificationSelfApi:I,requestShiftExtensionFromModal:h}=R(),T=C(),[g,b]=i.useState(!1),[x,c]=i.useState(!1),e=(l==null?void 0:l.details)||{},u=async()=>{var n,a,s;try{b(!0);const t=new Date().toISOString().slice(0,10),r=`lastHalfDayApplied_${y||"self"}`;if(localStorage.getItem(r)===t){alert("You have already applied a half-day leave today.");return}await p({from:t,to:t,type:"half-day",duration:.5,partOfDay:"AM",reason:`Missed login window (${((n=e==null?void 0:e.loginWindow)==null?void 0:n.startHH)||""} - ${((a=e==null?void 0:e.loginWindow)==null?void 0:a.endHH)||""})`});try{localStorage.setItem(r,t)}catch{}alert("Half-day leave applied.");const k=async()=>{try{const m=localStorage.getItem("erpToken"),L=await fetch("/api/leaves/my",{headers:{"Content-Type":"application/json",...m?{Authorization:`Bearer ${m}`}:{}}});if(!L.ok)return!1;const A=await L.json(),H=Array.isArray(A)?A.sort((N,D)=>new Date(D.createdAt)-new Date(N.createdAt))[0]:null;if((H==null?void 0:H.status)==="approved")return T("/home"),!0}catch{}return!1},E=setInterval(async()=>{await k()&&clearInterval(E)},5e3);(async()=>await k()&&clearInterval(E))(),d()}catch(t){console.error("applyHalfDay:",t);const r=(t==null?void 0:t.message)||((s=t==null?void 0:t.data)==null?void 0:s.message)||"Failed to apply leave. Try again or contact HR.";alert(r)}finally{b(!1)}},v=async()=>{var n,a,s;try{c(!0);const t=`Late login. Allowed ${((n=e==null?void 0:e.loginWindow)==null?void 0:n.startHH)||""}-${((a=e==null?void 0:e.loginWindow)==null?void 0:a.endHH)||""}, current ${(e==null?void 0:e.now)||""}`;await h({email:y,shiftType:(e==null?void 0:e.shiftType)||(e==null?void 0:e.displayName)||void 0,requestedMinutes:30,reason:t});try{const r="Shift extension request",f=`User ${y} requested a login extension for ${(e==null?void 0:e.displayName)||(e==null?void 0:e.shiftType)||""}.`;await I({title:r,body:f,meta:{email:y,shift:(e==null?void 0:e.shiftType)||null}})}catch{}alert("Extension request created and sent to your team lead."),d()}catch(t){console.error("requestExtension:",t);const r=(t==null?void 0:t.message)||((s=t==null?void 0:t.data)==null?void 0:s.message)||"Failed to send request. Try again or notify manager.";alert(r)}finally{c(!1)}},S={position:"fixed",inset:0,background:"rgba(0,0,0,0.45)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999},j={background:"#fff",padding:20,width:"min(720px, 96%)",borderRadius:10,boxShadow:"0 10px 30px rgba(0,0,0,0.3)"},w={padding:"10px 16px",borderRadius:6,marginRight:8,cursor:"pointer",border:"none"};return o.jsx("div",{style:S,role:"dialog","aria-modal":"true",children:o.jsxs("div",{style:j,children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[o.jsx("h3",{style:{margin:0},children:"â° Shift Login Blocked"}),o.jsx("button",{onClick:d,"aria-label":"Close",style:{background:"transparent",border:"none",fontSize:20},children:"âœ•"})]}),o.jsxs("div",{style:{marginTop:12},children:[o.jsx("p",{style:{color:"#b71c1c",fontWeight:600,marginBottom:8},children:l==null?void 0:l.message}),(e==null?void 0:e.loginWindow)&&o.jsxs("p",{style:{margin:0},children:["Allowed login window: ",o.jsxs("strong",{children:[e.loginWindow.startHH," - ",e.loginWindow.endHH]})]}),(e==null?void 0:e.now)&&o.jsxs("p",{style:{marginTop:8,color:"#444"},children:["Current server time: ",o.jsx("strong",{children:e.now})]}),o.jsxs("div",{style:{marginTop:18,display:"flex",gap:8,alignItems:"center"},children:[o.jsx("button",{onClick:u,disabled:g,style:{...w,background:"#0b63e5",color:"#fff"},children:g?"Applying...":"Apply Half-Day Leave"}),o.jsx("button",{onClick:v,disabled:x,style:{...w,background:"#1f8f4e",color:"#fff"},children:x?"Sending...":"Request Shift Extension"}),o.jsx("button",{onClick:d,style:{...w,background:"#eee"},children:"Close"})]}),o.jsx("div",{style:{marginTop:14,color:"#666",fontSize:13},children:o.jsx("p",{style:{margin:0},children:"Applying a half-day leave will mark your attendance for the day. Requesting extension will notify your manager to approve a late login."})})]})]})})}function M(){const{apiLogin:l,apiLogout:y}=R(),d=C(),[p,I]=i.useState(""),[h,T]=i.useState(""),[g,b]=i.useState(!1),[x,c]=i.useState(""),[e,u]=i.useState(!1),[v,S]=i.useState(null),j=i.useRef(null);i.useEffect(()=>{var n;(n=j.current)==null||n.focus()},[]),i.useEffect(()=>{const n=document.documentElement,a=document.getElementById("root"),s=document.body.style.overflow,t=n?n.style.overflow:"",r=a?a.style.overflow:"",f=a?a.style.height:"";return document.body.style.overflow="hidden",n&&(n.style.overflow="hidden"),a&&(a.style.overflow="hidden",a.style.height="100dvh"),()=>{document.body.style.overflow=s,n&&(n.style.overflow=t),a&&(a.style.overflow=r,a.style.height=f)}},[]);const w=async n=>{if(n.preventDefault(),c(""),S(null),!p||!h){c("âŒ Please enter both email and password.");return}u(!0);try{const a=p.trim().toLowerCase(),s=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:a,password:h})});let t=null;try{t=await s.json()}catch{t=null}if(!s.ok){const r=s.status,f=(t==null?void 0:t.code)||(r===403?"SHIFT_TIME_RESTRICTED":null),k=(t==null?void 0:t.message)||(r===403?"Login blocked due to shift timing":(t==null?void 0:t.error)||"Login failed");if(f==="LOGIN_CUTOFF"||f==="SHIFT_TIME_RESTRICTED"){const E=(t==null?void 0:t.details)||null;d("/late-login",{state:{shiftInfo:{...E,email:a},from:"login"}}),u(!1);return}if(r===401){c("âŒ Invalid email or password. Please try again."),u(!1);return}c(`ğŸ”§ Server error (${r}). ${k}`),u(!1);return}if(t!=null&&t.lateLogin)t.token&&(localStorage.setItem("token",t.token),localStorage.setItem("erpToken",t.token)),d("/late-login",{state:{shiftInfo:{...t.shiftInfo||{},email:a},from:"login"}});else{try{await l(a,h)}catch(r){console.warn("apiLogin hydration failed after direct fetch:",r)}d("/")}}catch(a){console.error("handleSubmit unexpected error:",a),c("âŒ An unexpected error occurred. Please try again.")}finally{u(!1)}};return o.jsxs("div",{className:"auth-background",style:{backgroundImage:"linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1522202176988-66273c2fd55f')",backgroundSize:"cover",backgroundPosition:"center",position:"fixed",top:64,left:0,right:0,bottom:0,width:"100vw",height:"calc(100dvh - 64px)",display:"flex",alignItems:"center",justifyContent:"center",padding:0,overflow:"hidden",boxSizing:"border-box"},"aria-busy":e,children:[v&&o.jsx(B,{data:v,email:p,onClose:()=>S(null)}),o.jsxs("div",{className:"auth-container",style:{background:"rgba(255,255,255,0.95)",padding:24,borderRadius:10,width:"100%",maxWidth:420,margin:0,maxHeight:"100%",overflowY:"auto"},children:[o.jsx("h2",{style:{textAlign:"center",marginBottom:20},children:"Login"}),x&&o.jsx("p",{role:"alert",style:{color:"red",marginBottom:10,textAlign:"center",wordBreak:"break-word"},children:x}),o.jsxs("form",{className:"auth-form",onSubmit:w,children:[o.jsxs("div",{className:"form-group",style:{marginBottom:12},children:[o.jsx("label",{htmlFor:"login-email",children:"Email"}),o.jsx("div",{style:{position:"relative",width:"100%"},children:o.jsx("input",{id:"login-email",ref:j,type:"email",placeholder:"you@example.com",value:p,onChange:n=>I(n.target.value),required:!0,autoComplete:"email",disabled:e,style:{width:"100%",paddingRight:16,boxSizing:"border-box"},"aria-label":"Email"})})]}),o.jsxs("div",{className:"form-group",style:{marginBottom:16},children:[o.jsx("label",{htmlFor:"login-password",children:"Password"}),o.jsxs("div",{style:{position:"relative",width:"100%"},children:[o.jsx("input",{id:"login-password",type:g?"text":"password",placeholder:"Your password",value:h,onChange:n=>T(n.target.value),required:!0,autoComplete:"current-password",disabled:e,style:{width:"100%",paddingRight:40,boxSizing:"border-box"},"aria-label":"Password"}),o.jsx("button",{type:"button",onClick:()=>b(n=>!n),style:{position:"absolute",right:12,top:"50%",transform:"translateY(-50%)",background:"transparent",border:"none",cursor:"pointer"},"aria-pressed":g,"aria-label":g?"Hide password":"Show password",disabled:e,children:g?"ğŸ™ˆ":"ğŸ‘ï¸"})]})]}),o.jsx("div",{className:"form-actions",style:{marginBottom:8},children:o.jsx("button",{className:"btn-primary",type:"submit",style:{width:"100%"},disabled:e,children:e?"Signing in...":"Login"})}),o.jsx("p",{style:{textAlign:"center",marginTop:10},children:o.jsx(q,{to:"/forgot-password",className:"link-text",children:"Forgot Password?"})})]})]})]})}export{M as default};
